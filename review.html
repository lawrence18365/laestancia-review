<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Estancia · Reseña</title>
  <style>
    :root {
      --bg: radial-gradient(circle at top, #1c1a18 0%, #0e0d0c 55%, #050505 100%);
      --card: rgba(12, 11, 10, 0.6);
      --border: rgba(255, 214, 142, 0.25);
      --gold: #e6c07b;
      --text: #f5f1ea;
      --muted: rgba(245, 241, 234, 0.7);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      padding: 20px;
    }
    .card {
      width: min(460px, 100%);
      background: linear-gradient(160deg, rgba(15,14,13,0.85), rgba(6,6,6,0.35));
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 26px 24px 22px;
      text-align: center;
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: rise 600ms ease-out;
    }
    @keyframes rise {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .logo {
      width: 160px;
      height: auto;
      margin: 0 auto 16px;
      display: block;
      border-radius: 999px;
      border: 1px solid rgba(230,192,123,0.28);
      background: rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 1.1rem;
      letter-spacing: 0.03em;
      margin-bottom: 0.45rem;
    }
    p.subtitle {
      margin-top: 0;
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .stars {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 1.5rem 0;
    }
    .star {
      font-size: 2.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: rgba(230,192,123,0.3);
      user-select: none;
    }
    .star:hover,
    .star.active {
      color: var(--gold);
      transform: scale(1.15);
    }
    .star:active {
      transform: scale(0.95);
    }
    .prompt {
      margin-top: 0.8rem;
      font-size: 0.8rem;
      color: var(--muted);
      min-height: 20px;
    }
    small {
      display: block;
      margin-top: 1.1rem;
      font-size: 0.7rem;
      color: rgba(245, 241, 234, 0.45);
    }
    small a {
      color: var(--gold);
      text-decoration: none;
      border-bottom: 1px solid rgba(230,192,123,0.35);
      padding-bottom: 1px;
    }
    @media (max-width: 460px) {
      .card {
        padding: 24px 18px 20px;
      }
      h1 {
        font-size: 1rem;
      }
      p.subtitle {
        font-size: 0.8rem;
      }
      .logo {
        width: 140px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <img
      src="https://i.postimg.cc/9fNDSz30/ac9a437c-35df-4b6e-9baa-8d08558366de.jpg"
      alt="La Estancia"
      class="logo"
    />
    <h1 id="msg">Gracias por tu visita — nuestro equipo te invita a compartir tu experiencia.</h1>
    <p class="subtitle">¿Cómo calificarías tu experiencia con nosotros?</p>

    <div class="stars">
      <span class="star" data-rating="1">★</span>
      <span class="star" data-rating="2">★</span>
      <span class="star" data-rating="3">★</span>
      <span class="star" data-rating="4">★</span>
      <span class="star" data-rating="5">★</span>
    </div>

    <p class="prompt">Toca las estrellas para calificar</p>

    <small>
      Tu opinión es importante para nosotros
    </small>
  </div>

  <script>
    // ========================================
    // GOOGLE SHEETS TRACKING CONFIGURATION
    // ========================================
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwtA_7AzGxpxENgdewVEmI52JLwNV41kHP9LMuNe3lcKBCkdWJSIwjiv9GODGvFG0iC/exec";
    const REVIEW_URL = "https://g.page/r/Caz8tUjHvtOBEBM/review";

    // Staff codes → names
    const STAFF = {
      "EDUARDO001": "Eduardo",
      "PEDROLOPEZ002": "Pedro López",
      "PEDROOROCIO003": "Pedro Orocio",
      "EMILIANO004": "Emiliano",
      "DAVID005": "David",
      "LEOGASCA006": "Leo Gasca",
      "LEOREYNOSO007": "Leo Reynoso",
      "ULISES008": "Ulises",
      "GERARDO009": "Gerardo",
      "CARLOS010": "Carlos",
      "JULIO011": "Julio",
      "FERNANDO012": "Fernando"
    };

    // Read ?card= from URL
    const params = new URLSearchParams(window.location.search);
    const cardCode = params.get('card');
    const staffName = cardCode && STAFF[cardCode.toUpperCase()] ? STAFF[cardCode.toUpperCase()] : null;

    // Update personalized message
    const msgEl = document.getElementById('msg');
    if (staffName) {
      msgEl.textContent = `Gracias por tu visita — ${staffName} te invita a compartir tu experiencia.`;
    }

    // Send tracking data to Google Sheets
    // CORS-compatible: Uses text/plain content type to avoid preflight requests
    function trackCardScan(rating) {
      if (WEBHOOK_URL && WEBHOOK_URL !== "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
        const data = {
          cardCode: cardCode ? cardCode.toUpperCase() : null,
          staffName: staffName || 'Unknown',
          rating: rating,
          timestamp: new Date().toISOString()
        };

        // Using text/plain prevents CORS preflight (OPTIONS) requests
        // redirect: "follow" is required for Google Apps Script
        fetch(WEBHOOK_URL, {
          redirect: "follow",
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: JSON.stringify(data)
        })
        .then(response => response.text())
        .then(responseText => {
          console.log('Tracking successful:', responseText);
        })
        .catch(err => {
          console.error('Tracking error:', err);
          // Fail silently - user experience continues even if tracking fails
        });
      }
    }

    // Star rating functionality
    const stars = document.querySelectorAll('.star');
    const promptEl = document.querySelector('.prompt');

    stars.forEach((star, index) => {
      // Hover effect
      star.addEventListener('mouseenter', () => {
        stars.forEach((s, i) => {
          if (i <= index) {
            s.classList.add('active');
          } else {
            s.classList.remove('active');
          }
        });
      });

      // Click handler
      star.addEventListener('click', () => {
        const rating = parseInt(star.dataset.rating);

        // Track the rating
        trackCardScan(rating);

        // Show feedback
        promptEl.textContent = '¡Gracias por tu calificación!';

        if (rating === 5) {
          // 5 stars - redirect to Google Reviews (silent redirect)
          setTimeout(() => {
            window.location.href = REVIEW_URL;
          }, 800);
        } else {
          // 4 or below - redirect to feedback form
          promptEl.textContent = 'Queremos mejorar, por favor cuéntanos más...';
          setTimeout(() => {
            // Pass the rating and staff info to the feedback form
            const feedbackUrl = `feedback.html?rating=${rating}&card=${cardCode || ''}&staff=${encodeURIComponent(staffName || 'Unknown')}`;
            window.location.href = feedbackUrl;
          }, 1000);
        }
      });
    });

    // Reset stars when mouse leaves
    document.querySelector('.stars').addEventListener('mouseleave', () => {
      stars.forEach(s => s.classList.remove('active'));
    });
  </script>
</body>
</html>
